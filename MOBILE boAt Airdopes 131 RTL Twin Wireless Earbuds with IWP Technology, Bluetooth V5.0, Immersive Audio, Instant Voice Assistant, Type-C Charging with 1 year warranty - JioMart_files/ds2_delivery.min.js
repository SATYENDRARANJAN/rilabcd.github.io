class Deliver{constructor(){this.userid=localStorage.getItem("userid"),this.authtoken=localStorage.getItem("authtoken")}async get_pincode_details(pincode){let pincode_api=$("#mst_api_cart_pin_baseurl").val(),result=[];return $.ajax({url:pincode_api+"pin/"+pincode,method:"GET",async:!1,dataType:"JSON",success:function(resp){result=resp},error:function(xhr,status,error){result=xhr.responseJSON}}),await Promise.resolve(result)}async get_region_stores_code(pincode){let pincode_url="/collection/mcat_pincode/get_mcat_inventory_code/"+pincode;return $.ajax({url:pincode_url,method:"GET",async:!1,data:{},dataType:"JSON",success:function(resp){let inv_today=new Date;inv_today.setHours(inv_today.getHours()+1),localStorage.setItem("jio_inventory_store_code",JSON.stringify(resp.store_codes)),localStorage.setItem("jio_inventory_code_expiry",inv_today),localStorage.setItem("jio_region_codes",JSON.stringify(resp.region_codes));let reg_today=new Date;reg_today.setHours(reg_today.getHours()+12),localStorage.setItem("jio_region_code_expiry",reg_today)},error:function(){}}),await Promise.resolve("success")}async get_customer_address_details(){if(this.authtoken&&this.userid){let domain_url,url=$("#mstar_api_baseurl").val()+"address/v2/get/all",address_list=[],self=this;return $.ajax({url:url,data:{},headers:{userid:this.userid,authtoken:this.authtoken},method:"GET",dataType:"JSON",async:!1,success:function(resp){"success"==resp.status&&(address_list=resp.result.address_list)},error:function(){}}),await Promise.resolve(address_list)}}async get_customer_default_shipping_address(){let domain_url,def_addr_api=$("#mstar_api_baseurl").val()+"entity/customer/get_details",def_addr_id=0;return $.ajax({url:def_addr_api,data:{},headers:{userid:this.userid,authtoken:this.authtoken},method:"GET",dataType:"JSON",async:!1,success:function(resp){"success"==resp.status&&resp.result.your_details.preferred_shipping_address&&(def_addr_id=resp.result.your_details.preferred_shipping_address)},error:function(){}}),await Promise.resolve(def_addr_id)}async set_default_shipping_address(address_id){let result=!1;if(address_id){let domain_url,url=$("#mstar_api_baseurl").val()+"entity/customer/set_preferred_shipping_address/"+address_id;$.ajax({url:url,data:{},headers:{userid:this.userid,authtoken:this.authtoken},method:"GET",dataType:"JSON",async:!1,success:function(resp){"success"==resp.status&&(result=!0)},error:function(xhr,status,error){}})}return await Promise.resolve(result)}async set_default_billing_address(address_id){let result=!1;if(address_id){let domain_url,url=$("#mstar_api_baseurl").val()+"entity/customer/set_preferred_billing_address/"+address_id;$.ajax({url:url,data:{},headers:{userid:this.userid,authtoken:this.authtoken},method:"GET",dataType:"JSON",async:!1,success:function(resp){"success"==resp.status&&(result=!0)},error:function(xhr,status,error){}})}return await Promise.resolve(result)}}const deliver_obj=new Deliver;$(document).ready((function(){null!=localStorage.getItem("userid")&&"0"!=localStorage.getItem("userid")&&(localStorage.getItem("is_default_pin")||localStorage.setItem("is_default_pin","no"));let pin=window.default_pin;if(localStorage.getItem("nms_mgo_pincode")&&(pin=localStorage.getItem("nms_mgo_pincode")),localStorage.getItem("is_default_addr")){let rg_code_expiry=localStorage.getItem("jio_region_code_expiry"),reg_today=new Date,reg_expiry_date=new Date(rg_code_expiry);reg_today.getTime()>reg_expiry_date.getTime()&&deliver_obj.get_region_stores_code(pin);let inv_expiry=localStorage.getItem("jio_inventory_code_expiry"),inv_today=new Date,inv_expiry_date=new Date(inv_expiry);inv_today.getTime()>inv_expiry_date.getTime()&&deliver_obj.get_region_stores_code(pin)}else console.log("default pin details"),localStorage.setItem("nms_mgo_pincode",pin),localStorage.setItem("is_default_addr","no"),deliver_obj.get_pincode_details(pin).then(result=>{process_pincode_result(result,"default",!0)});let url,url_pin=(new Url).query.pin,pinregex,valid;/^[0-9]{6}$/.test(url_pin)&&localStorage.getItem("nms_mgo_pincode")!=url_pin&&deliver_obj.get_region_stores_code(url_pin)}));let delivery_first_click=!0;function showGeoPosition(p){let geocoder=new google.maps.Geocoder,LatLng=new google.maps.LatLng(p.coords.latitude,p.coords.longitude);geocoder.geocode({location:LatLng},(function(results,status){if("OK"===status){if(results[0])if(results[0].address_components){let address_components=results[0].address_components;for(i=0;i<address_components.length;i++)if(address_components[i].types){let types;if(address_components[i].types.indexOf("postal_code")>=0){let pincode=address_components[i].long_name;deliver_obj.get_pincode_details(pincode).then(result=>{$("#pickup_popup").hasClass("jm-bottomsheet-visible")?process_pincode_result(result,"detect-store-pickup",!1):process_pincode_result(result,"detect",!0)})}}}else{let message_elem=$("#detect_locate_msg");$("#pickup_popup").hasClass("jm-bottomsheet-visible")&&(message_elem=$("#pickup_detect_location_msg")),message_elem.removeClass().html("Unable to get location details").addClass("jm-fc-light-feedback-error-80")}}else{let message_elem=$("#detect_locate_msg");$("#pickup_popup").hasClass("jm-bottomsheet-visible")&&(message_elem=$("#pickup_detect_location_msg")),message_elem.removeClass().html("Unable to get location details").addClass("jm-fc-light-feedback-error-80")}}))}function showGeoError(error){let error_msg="Unable to get location details";switch(error.code){case error.PERMISSION_DENIED:error_msg="Permission required to access your location.";break;case error.POSITION_UNAVAILABLE:error_msg="Location information is unavailable.";break;case error.TIMEOUT:error_msg="The request to get your location has timed out.";break;case error.UNKNOWN_ERROR:error_msg="An unknown error occurred."}let message_elem=$("#detect_locate_msg");$("#pickup_popup").hasClass("jm-bottomsheet-visible")&&(message_elem=$("#pickup_detect_location_msg")),message_elem.removeClass().addClass("jm-fc-light-feedback-error-80").html(error_msg)}function process_pincode_result(resp,source,submit){let msg_elem="",pin_elem="";if("form"==source?(msg_elem="#delivery_pin_msg",pin_elem="#rel_pincode"):"detect"==source?(pin_elem="#rel_pincode",msg_elem="#detect_locate_msg"):"detect-store-pickup"==source&&(pin_elem="#pickup_pin",msg_elem="#pickup_detect_location_msg"),resp.status&&"success"==resp.status){$("#pin_input_holder").removeClass("error error-input-anim").addClass("input-has-success-text");let result=resp.result,master_codes=result.master_codes,supported=!1,pincode=result.pin;for(vertical in $(pin_elem).val(pincode),master_codes)null!=master_codes[vertical]&&(supported=!0);if(1==supported){let message=result.city+", "+result.state_name;if("detect-store-pickup"!=source&&($(msg_elem).removeClass().addClass("field-success").text(message),"detect"==source&&$(msg_elem).addClass("jm-fc-light-feedback-success-80")),submit){$.cookie("nms_mgo_pincode",pincode,{path:"/",expires:30}),$.cookie("nms_mgo_city",result.city,{path:"/",expires:30}),$.cookie("nms_mgo_state_code",result.state_code,{path:"/",expires:30}),localStorage.setItem("nms_mgo_pincode",pincode),localStorage.setItem("nms_mgo_city",result.city),localStorage.setItem("nms_mgo_state_code",result.state_code),localStorage.setItem("jio_vertical_city_code",JSON.stringify(result.master_codes)),localStorage.setItem("is_default_pin","no"),localStorage.setItem("jio_popup_pincode","yes"),localStorage.removeItem("jio_personalised_products"),localStorage.removeItem("jio_personalised_products_expiry"),localStorage.removeItem("jio_pickup_stores"),localStorage.removeItem("is_pickup_supported"),localStorage.removeItem("jio_store_id"),localStorage.removeItem("jio_srch_discover_more");let lat=0,lon=0;result.lat&&0!=result.lat&&(lat=result.lat,localStorage.setItem("jio_addr_lat",lat)),result.lon&&0!=result.lon&&(lon=result.lon,localStorage.setItem("jio_addr_lon",lon)),0!=lat&&0!=lon||getLatLonAPI(pincode),pincodePurelyGtmEvents(),deliver_obj.get_region_stores_code(pincode);let url_c=new Url;url_c.query&&url_c.query.pin&&delete url_c.query.pin,"default"!=source&&(window.location.href=url_c.toString())}if("detect-store-pickup"==source){get_available_stores(pincode,!0);let data=[];localStorage.getItem("jio_pickup_formdata")&&(data=JSON.parse(localStorage.getItem("jio_pickup_formdata"))),bind_store_details(data,!0)}}else{let message="We are currently not delivering at this location.";pincodePurelyGtmEvents(),$(msg_elem).removeClass().addClass("field-error").text(message)}}else if("fail"==resp.status){let message=resp.reason.reason_eng;"NOT_FOUND"==resp.reason.reason_code&&(message="We are currently not delivering at this location."),$(msg_elem).removeClass().addClass("field-error").html(message),"form"==source&&$("#pin_input_holder").removeClass("input-has-success-text").addClass("error error-input-anim")}else"form"==source&&$("#pin_input_holder").removeClass("input-has-success-text").addClass("error error-input-anim"),$(msg_elem).removeClass().addClass("field-error").html("Unable to fetch delivery details")}function bindDeliveryPopup(){localStorage.getItem("userid")&&"0"!=localStorage.getItem("userid")&&($("#delivery_title").text("Select Delivery Location"),$("#delivery_desc").text("Select a delivery location to see product availability, offers and discounts."),$("#delivery_signin").hide(),$("#delivery_address").show()),$("#delivery_content").show(),$("#delivery_enter_pincode").hide()}function getLatLonAPI(pincode){let geocoder;(new google.maps.Geocoder).geocode({componentRestrictions:{country:"IN",postalCode:pincode.toString()}},(function(results,status){if("OK"===status)if(results[0]){let results=JSON.stringify(results[0]);if(results=JSON.parse(results),results.geometry&&results.geometry.location){let lat=results.geometry.location.lat,lon=results.geometry.location.lng;localStorage.setItem("jio_addr_lat",lat),localStorage.setItem("jio_addr_lon",lon)}}else localStorage.setItem("jio_addr_lat","0"),localStorage.setItem("jio_addr_lon","0");else localStorage.setItem("jio_addr_lat","0"),localStorage.setItem("jio_addr_lon","0")}))}$(document).on("click","#btn_delivery",(function(){bindDeliveryPopup(),$("#delivery_popup").addClass("jm-bottomsheet-visible"),$("body").addClass("disable-scroll"),delivery_first_click&&(delivery_first_click=!1,0!=localStorage.getItem("userid")&&null!=localStorage.getItem("userid")&&deliver_obj.get_customer_default_shipping_address().then(def_addr_id=>{deliver_obj.get_customer_address_details().then(address_list=>{if(address_list&&address_list.length>0){let addIndex=address_list.findIndex(x=>x.id===def_addr_id);if(addIndex&&addIndex>0){let swapArrayElements;(function(address_list,indexA,indexB){let temp=address_list[indexA];address_list[indexA]=address_list[indexB],address_list[indexB]=temp})(address_list,0,addIndex)}let user_addr_html=address_list.map(address=>{if(1==address.is_active&&0==address.subs_eligible){let addr_class="";return def_addr_id==address.id&&"yes"==localStorage.getItem("is_default_addr")&&(addr_class+=" active"),`<div class="${addr_class} delivery-location-item" data-id="${address.id}" data-pin="${address.pin}" data-name="${address.addressee_name}">\n                                        <div class="delivery-location-name">\n                                            ${address.addressee_name}\n                                        </div>\n                                        <div class="delivery-location-address">\n                                            ${address.area_name},\n                                            ${address.building_address},\n                                            ${address.city}, ${address.state}\n                                        </div>\n                                        <div class="delivery-location-pincode">\n                                            ${address.pin}\n                                        </div>\n                                        <div class="delivery-location-type">\n                                            <div class="jm-badge ${addr_class?"jm-badge-primary":"jm-badge-secondary"} text-capitalize">${"other"==address.address_type?address.address_type_other:address.address_type}</div>\n                                        </div>\n                                </div>`}return""});$("#delivery_address").html(user_addr_html)}else{let user_addr_html='<a href="/customer/account/address">\n                            <div class="delivery-location-item-add">\n                                <button class="jm-btn secondary medium">\n                                    <img src="/assets/ds2msite/jds-icons/add-icon.svg" alt="add address" />\n                                </button>\n                                <button class="jm-btn tertiary medium">Add new address</button>\n                            </div>\n                        </a>';$("#delivery_address").html(user_addr_html)}})}))})),$(document).on("click",".myjiostore #btn_delivery",(function(){bindDeliveryPopup(),$("#delivery_popup").addClass("jm-bottomsheet-visible"),$("body").addClass("disable-scroll"),0!=localStorage.getItem("userid")&&null!=localStorage.getItem("userid")&&(deliver_obj.userid=localStorage.getItem("userid"),null!=localStorage.getItem("authtoken")&&null!=localStorage.getItem("authtoken")&&(deliver_obj.authtoken=localStorage.getItem("authtoken")),deliver_obj.get_customer_default_shipping_address().then(def_addr_id=>{deliver_obj.get_customer_address_details().then(address_list=>{if(address_list&&address_list.length>0){var isActive=0;let addIndex=address_list.findIndex(x=>x.id===def_addr_id);if(addIndex&&addIndex>0){let swapArrayElements;(function(address_list,indexA,indexB){let temp=address_list[indexA];address_list[indexA]=address_list[indexB],address_list[indexB]=temp})(address_list,0,addIndex)}let user_addr_html=address_list.map(address=>{if(1==address.is_active&&0==address.subs_eligible){let addr_class="";return def_addr_id==address.id?$("body").hasClass("myjiostore")&&localStorage.getItem("nms_mgo_pincode")?address.pin&&localStorage.getItem("nms_mgo_pincode")==address.pin&&isActive<1&&(addr_class+=" active",isActive++):"yes"==localStorage.getItem("is_default_addr")&&(addr_class+=" active",$("body").hasClass("myjiostore")&&isActive<1&&isActive++):$("body").hasClass("myjiostore")&&localStorage.getItem("nms_mgo_pincode")&&address.pin&&localStorage.getItem("nms_mgo_pincode")==address.pin&&isActive<1&&(addr_class+=" active",isActive++),$("body").hasClass("myjiostore")&&(addr_class&&-1!==addr_class.indexOf("active")?(localStorage.setItem("is_default_addr","yes"),localStorage.setItem("pincode_exist","yes")):localStorage.setItem("pincode_exist","no")),`<div class="${addr_class} delivery-location-item" data-id="${address.id}" data-pin="${address.pin}" data-name="${address.addressee_name}">\n                                    <div class="delivery-location-name">\n                                        ${address.addressee_name}\n                                    </div>\n                                    <div class="delivery-location-address">\n                                        ${address.area_name},\n                                        ${address.building_address},\n                                        ${address.city}, ${address.state}\n                                    </div>\n                                    <div class="delivery-location-pincode">\n                                        ${address.pin}\n                                    </div>\n                                    <div class="delivery-location-type">\n                                        <div class="jm-badge ${addr_class?"jm-badge-primary":"jm-badge-secondary"} text-capitalize">${"other"==address.address_type?address.address_type_other:address.address_type}</div>\n                                    </div>\n                            </div>`}return""});$("#delivery_address").html(user_addr_html)}else{let user_addr_html='<a href="/customer/account/address">\n                        <div class="delivery-location-item-add">\n                            <button class="jm-btn secondary medium">\n                                <img src="/assets/ds2msite/jds-icons/add-icon.svg" alt="add address" />\n                            </button>\n                            <button class="jm-btn tertiary medium">Add new address</button>\n                        </div>\n                    </a>';$("#delivery_address").html(user_addr_html)}})}))})),$(document).on("click","#btn_enter_pincode",(function(){$("#delivery_content").hide(),$("#delivery_title").text("Enter PIN Code"),$("#delivery_enter_pincode").show(),$("#rel_pincode").focus(),document.getElementById("delivery_pincode_form").reset(),$("#pin_input_holder").removeClass("input-has-success-text").removeClass("error error-input-anim"),$("#delivery_pin_msg").text("").removeClass()})),$("#rel_pincode").keypress((function(event){let charCode=event.which?event.which:event.keyCode;return charCode>=37&&charCode<=40||(46==charCode||!(charCode>31&&(charCode<48||charCode>57))&&void 0)})),$(document).on("input","#rel_pincode",(function(){let pincode=$(this).val(),pinregex,valid=/^[0-9]{6}$/.test(pincode);$("#delivery_pin_msg").text(""),valid?($("#btn_pincode_submit").prop("disabled",!1),deliver_obj.get_pincode_details(pincode).then(result=>{process_pincode_result(result,"form",!1)})):($("#btn_pincode_submit").prop("disabled",!0),$("#pin_input_holder").removeClass("input-has-success-text").removeClass("error error-input-anim"))})),$(document).on("submit","#delivery_pincode_form",(function(ev){ev.preventDefault();let pincode=$("#rel_pincode").val(),pinregex,valid;if(/^[0-9]{6}$/.test(pincode)){let pin_exist=!1;$(".delivery-location-item").each((function(i,el){var el_pin=$(el).attr("data-pin");if(pincode==el_pin)return localStorage.setItem("pincode_exist","yes"),localStorage.setItem("is_default_addr","yes"),$(el).trigger("click"),pin_exist=!0,!1})),0==pin_exist&&(localStorage.setItem("pincode_exist","no"),localStorage.removeItem("display_ship_name"),deliver_obj.get_pincode_details(pincode).then(result=>{process_pincode_result(result,"form",!0)}))}else $("#delivery_pin_msg").removeClass().addClass("field-error").text("Invalid pincode")})),$("#btn_detect_location").click((function(){$("#detect_locate_msg").text(""),navigator.geolocation?navigator.geolocation.getCurrentPosition(showGeoPosition,showGeoError):$("#detect_locate_msg").removeClass().addClass("jm-fc-light-feedback-error-80").html("Sorry, your browser does not support HTML5 geolocation.")})),$(document).on("click",".delivery-location-item",(function(){localStorage.setItem("pincode_exist","yes");let pin=$(this).attr("data-pin"),addr_id=$(this).attr("data-id"),name=$(this).attr("data-name");localStorage.setItem("display_ship_name",name),deliver_obj.set_default_shipping_address(addr_id).then(status=>{status&&deliver_obj.set_default_billing_address(addr_id).then(status=>{status&&deliver_obj.get_pincode_details(pin).then(resp=>{process_pincode_result(resp,"address_list",!0)})})})})),$("#btn_delivery_close").click((function(){$("#delivery_popup").removeClass("jm-bottomsheet-visible"),$("body").removeClass("disable-scroll")}));