import AlgoliaFilters from"./algolia_filters.js";export class Recommended{constructor(){this.load_personalised=!0}check_personalised_local_storage(){let pincode,pers_pincode;localStorage.getItem("nms_mgo_pincode")!=localStorage.getItem("jio_personalised_products_pincode")&&localStorage.removeItem("jio_personalised_products_expiry");let personalised_expiry=localStorage.getItem("jio_personalised_products_expiry"),pers_today=new Date,pers_expiry_date=new Date(personalised_expiry);pers_today.getTime()>pers_expiry_date.getTime()?this.get_personalised_sku():this.bind_personalised_products()}get_personalised_sku(){if(1==this.load_personalised){this.load_personalised=!1;let userid=localStorage.getItem("userid"),authtoken=localStorage.getItem("authtoken"),self=this;$.ajax({url:window.personalised.api_url,type:"GET",data:{},dataType:"JSON",headers:{userid:userid,authtoken:authtoken},success:function(resp){if("success"==resp.status&&resp.result.productList&&resp.result.productList.length>0){let products_list=resp.result.productList;products_list.length>0&&self.get_personalised_products_from_algolia(products_list)}},error:function(){}})}}get_personalised_products_from_algolia(all_sku){let alg_filter_object,filters_arr=(new AlgoliaFilters).get_default_filters(),region_filter=filters_arr[0],inventory_filter=filters_arr[1],product_filters,filters=`(${all_sku.map(sku=>`product_code:${sku}`).join(" OR ")}) AND ${region_filter} AND ${inventory_filter}`,self=this,algolia_api_url=`https://${window.algolia_app_id}-dsn.algolia.net/1/indexes/${window.algolia_suffix}_master_vertical?query=&hitsPerPage=${window.personalised.limit}&filters=${filters}`;$.ajax({url:algolia_api_url,type:"GET",headers:{"X-Algolia-API-Key":window.algolia_api_key,"X-Algolia-Application-Id":window.algolia_app_id},data:{},dataType:"JSON",success:function(resp){if(resp.hits&&resp.hits.length>0){let products=[],master_code=JSON.parse(localStorage.getItem("jio_region_codes"));resp.hits.map(hit=>{let prod_vert=hit.vertical_code;var vert_region_codes=master_code[prod_vert]?master_code[prod_vert]:[];let region_code="";for(let p in vert_region_codes){let vcode=vert_region_codes[p];hit.store_wise_mrp[vcode]&&hit.store_wise_mrp[vcode].available&&(region_code=vcode)}let obj={display_name:hit.display_name,image_url:hit.image_url,url_path:hit.url_path,product_code:hit.product_code,max_qty_in_order:hit.max_qty_in_order,in_stock:hit.in_stock,vertical_code:hit.vertical_code};if(""!=region_code){let reg_value=hit.store_wise_mrp[region_code];obj.selling_price=reg_value.price,obj.mrp=reg_value.mrp,obj.discount_pt=reg_value.discount_pt}products.push(obj)});let pin=localStorage.getItem("nms_mgo_pincode");localStorage.setItem("jio_personalised_products",JSON.stringify(products));let pers_today=new Date;pers_today.setHours(pers_today.getHours()+2),localStorage.setItem("jio_personalised_products_expiry",pers_today),localStorage.setItem("jio_personalised_products_pincode",pin),self.bind_personalised_products()}},error:function(){}})}bind_personalised_products(){let recommend_html="",products=JSON.parse(localStorage.getItem("jio_personalised_products"));products.length>0&&(recommend_html+='<div class="search-recommended-title">\n                Recommended products\n            </div>\n            <div class="search-recommended-item">',products.map(product=>{recommend_html+=`<div class="recommended-product">\n                <a href="${product.url_path}">\n                <div class="recommended-product-image-container">\n                  <div class="recommended-product-image">\n                    <img\n                      src="${window.product_image_path}${product.image_url}"\n                      alt="${product.display_name}"\n                    />\n                  </div>\n                  <div class="recommended-product-wishlist">\n                    <div class="jm-wishlist-btn small wishlist_btn" data-sku="${product.product_code}" id="wishlist_${product.product_code}" data-showtoast="no"></div>\n                  </div>\n                </div>\n    \n                <div class="recommended-product-title">\n                    ${product.display_name}\n                </div>\n                \n                <div class="recommended-product-listing-price">\n                  &#8377;${product.selling_price}\n                </div>\n                <div class="recommended-product-effective-price-container">\n                    ${product.selling_price!=product.mrp?`\n                    <span class="recommended-product-effective-price">&#8377;${product.mrp}</span>`:""}\n                    ${product.discount_pt>0?`\n                    <span class="jm-badge jm-badge-small">${product.discount_pt}% OFF</span>`:""}\n                </div>\n    \n                <div class="recommended-product-cta" data-parentbtn-class="small secondary" data-parentbtn-text="Add" data-parentbtn-image="1" data-minusclass="secondary small jm-icon center" data-plusclass="secondary small jm-icon center" data-countclass="recommended-product-quantity">\n                  <button class="jm-btn secondary small full-width addtocartbtn" data-sku="${product.product_code}">\n                    Add\n                    <img src="/assets/ds2web/jds-icons/add-icon.svg" alt="" />\n                  </button>\n                </div>\n                </a>\n              </div>`}),recommend_html+="</div>",$("#search_initial_recommended").html(recommend_html),apply_wishlist(""),applyPlusMinusButton())}bind_recent_searches(){if(localStorage.getItem("nms_alg_rec_searches")){let recent_srch=JSON.parse(localStorage.getItem("nms_alg_rec_searches"));if(recent_srch.length>0){let rec_html='<div class="search-recent-title">\n                    <div>Recent Searches</div>\n                    <div>\n                        <button class="jm-btn tertiary small" id="clear_recent_search">\n                        Clear All\n                        </button>\n                    </div>\n                </div>\n                <div class="search-recent-item truncate-text">';recent_srch.map(keyword=>{let query=keyword.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),href=keyword.toString().replace(/%/g,"~pct~");href=encodeURIComponent(keyword);let str_id="";localStorage.getItem("jio_store_id")&&(str_id="?str_id="+localStorage.getItem("jio_store_id")),rec_html+=`<a class="jm-btn secondary small jm-body-xs jm-fc-black" href="/search/${href}${str_id}">${query}</a>`}),rec_html+="</div>",$("#search_initial_recent").html(rec_html)}}}get_discover_more_from_algolia(){if(localStorage.getItem("jio_srch_discover_more"))this.bind_discover_more();else{let aa_filters="",aa_mstar_vertical_code=JSON.parse(localStorage.getItem("jio_vertical_city_code"));for(let vertical in aa_mstar_vertical_code)if(aa_mstar_vertical_code[vertical]);else{var cat_name=vertical.toLowerCase();aa_filters+="NOT category_level.level1:"+(cat_name=cat_name.charAt(0).toUpperCase()+cat_name.slice(1))+" AND "}""!=aa_filters&&(aa_filters=aa_filters.slice(0,-5));let algolia_api_url=`https://${window.algolia_app_id}-dsn.algolia.net/1/indexes/${window.algolia_suffix}_query_suggestions?query=&hitsPerPage=10&filters=${aa_filters}`,self=this;$.ajax({url:algolia_api_url,type:"GET",headers:{"X-Algolia-API-Key":window.algolia_api_key,"X-Algolia-Application-Id":window.algolia_app_id},data:{},dataType:"JSON",success:function(resp){if(resp.hits&&resp.hits.length>0){let queries=resp.hits.map(hit=>hit.query);localStorage.setItem("jio_srch_discover_more",queries.join()),self.bind_discover_more()}},error:function(){}})}}bind_discover_more(){let queries=localStorage.getItem("jio_srch_discover_more");queries=queries.split(",");let html=queries.map(keyword=>{let query=keyword.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),href=keyword.toString().replace(/%/g,"~pct~");href=encodeURIComponent(keyword);let str_id="";return localStorage.getItem("jio_store_id")&&(str_id="?str_id="+localStorage.getItem("jio_store_id")),`<a class="jm-btn secondary small jm-body-xs jm-fc-black" href="/search/${href}${str_id}">${query}</a>`}).join("");$("#search_initial_discover_more").html(html)}bind_popular_categories(){let popular_categories=window.popular_categories;if(popular_categories.length>0){let pincode_supported_verticals=[],aa_mstar_vertical_code=JSON.parse(localStorage.getItem("jio_vertical_city_code"));for(var vertical in aa_mstar_vertical_code)aa_mstar_vertical_code[vertical]&&pincode_supported_verticals.push(vertical);if(pincode_supported_verticals.length>0){let str_id="";localStorage.getItem("jio_store_id")&&(str_id="?str_id="+localStorage.getItem("jio_store_id"));let popular_cat_html=pincode_supported_verticals.map(vertical=>{let cat=popular_categories.find(category=>category.vertical_code==vertical);return cat?`<a class="search-popular-category" href="${cat.url_path}${str_id}">\n                                    <div class="search-popular-category-image">\n                                        <img src="${window.product_image_path+cat.thumbnail_image_path}" alt="${cat.name}" />\n                                    </div>\n                                    <div class="search-popular-category-title">${cat.name}</div>\n                                </a>\n                            `:""}).join("");$("#search_initial_popular_categories").html(popular_cat_html)}}}}let recommend=new Recommended;function process_show_search_initial(){$("#search_initial").addClass("jm-page-bottomsheet-visible"),$("body").addClass("disable-scroll"),setTimeout((function(){$(".search_input").focus()}),100),recommend.bind_recent_searches(),recommend.get_discover_more_from_algolia(),recommend.bind_popular_categories(),null!=localStorage.getItem("userid")&&"0"!=localStorage.getItem("userid")&&recommend.check_personalised_local_storage()}$(document).on("click","#clear_recent_search",(function(){var gtmStatus;if("1"==document.getElementById("gtm_status").value){var event="",category="",action="",label="",search_term="",suggestive_search_count="",site_search_results_count="",suggestive_search_term_clicked="",suggestive_search_term_index="";event="event_site_search",category="site search",action="recent searches cleared",label="site_search_recent_searches_cleared";var recentCount=0;$(".search-recent-item a").length>0&&(recentCount=$(".search-recent-item a").length),"undefined"!=typeof SearchPurelyGtmEvents&&SearchPurelyGtmEvents(event,category,action,label,search_term="clear all_"+recentCount+"keywords","","","")}localStorage.removeItem("nms_alg_rec_searches"),$("#search_initial_recent").html("")})),$(document).on("focus",".search_input",(function(){let srch_keyword;""==$(this).val()?(recommend.bind_recent_searches(),recommend.get_discover_more_from_algolia(),null!=localStorage.getItem("userid")&&"0"!=localStorage.getItem("userid")&&recommend.check_personalised_local_storage(),$("#search_empty_holder").show(),$(".aa-Panel").hide()):($("#search_empty_holder").hide(),$(".aa-Panel").show())})),$(document).on("focus","#type_one_search",(function(){$(this).blur();let kw=$(this).val();""!=kw&&($(".aa-Panel").show(),setQuery(kw),setIsOpen(!0)),process_show_search_initial()})),$(document).on("click","#btn_mini_search",(function(){process_show_search_initial()})),$(document).on("click",".aa-ClearButton",(function(){setTimeout((function(){$(".search_input").focus()}),100)}));